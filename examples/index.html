<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Shooter Example — Networked-Aframe</title>
  <meta name="description" content="Shooter Example — Networked-Aframe" />

  <!-- <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script> -->
  <script src="../dist/aframe.min.js"></script>

  <script src="https://cdn.socket.io/4.5.3/socket.io.min.js"
    integrity="sha384-WPFUvHkB1aHA5TDSZi6xtDgkF0wXJcIIxXhC6h8OT8EH3fC5PWro5pWJ1THjcfEi"
    crossorigin="anonymous"></script>
  <script src="../dist/socketio_client_4.5.3.min.js"></script>

  <!-- <script src="https://unpkg.com/networked-aframe@^0.10.0/dist/networked-aframe.min.js"
    crossorigin="anonymous"></script> -->
  <script src="../dist/networked-aframe.min.js"></script>

  <script src="../dist/mediasoup-adapter.js"></script>
  <!-- mediasoup-client necessary -->
  <script src="../dist/mediasoup-client.min.js"></script>
  <script>
    console.log('mediasoup-client-version', mediasoupClient.version);
  </script>

  <script src="https://unpkg.com/aframe-randomizer-components@^3.0.1/dist/aframe-randomizer-components.min.js"></script>
  <script src="https://unpkg.com/aframe-environment-component@1.3.1/dist/aframe-environment-component.min.js"></script>

  <!-- get-stats -->
  <script src="./js/get-stats.js"></script>
  <script src="./js/get-device-info.js"></script>
  <style>
    .statsPanel {
      position: absolute;
      bottom: 30px;
      left: 10px;
      width: 900px;
      height: 500px;
      z-index: 99;
      color: white;
      overflow: auto;
    }

    table {
      width: 100%;
      height: 80%;
    }

    .value {
      text-align: center;
      width: 800px;
      max-width: 1000px;
      overflow: auto
    }

    td {
      text-align: center
    }


    .btn {
      display: flex;
      width: 50%;
      justify-content: center;
      align-items: center;

    }

    .stopBtn {
      width: 100%;
      margin: 10px auto;
      text-align: center;
    }
  </style>
</head>

<body>
  <a-scene networked-scene="
      room: shooter;
      debug: true;
      adapter: mediasoup;
      video: false;
      audio: false;
    ">
    <a-assets timeout="1000">
      <!-- Templates -->
      <img id="sky" src="" crossorigin="anonymous" />
      <!-- Avatar -->
      <template id="avatar-template">
        <a-entity class="avatar">
          <a-plane color="#FFF" width="4" height="3" position="0 3 0" material="side: back" networked-video-source>
          </a-plane>
          <a-plane color="#FFF" width="4" height="3" rotation="0 0 0" position="0 5 0" material="side: front"
            networked-audio-source>
          </a-plane>
          </a-plane>
          <a-sphere class="head" scale="0.45 0.5 0.4"></a-sphere>
          <a-entity class="face" position="0 0.05 0">
            <a-sphere class="eye" color="#efefef" position="0.16 0.1 -0.35" scale="0.12 0.12 0.12">
              <a-sphere class="pupil" color="#000" position="0 0 -1" scale="0.2 0.2 0.2"></a-sphere>
            </a-sphere>
            <a-sphere class="eye" color="#efefef" position="-0.16 0.1 -0.35" scale="0.12 0.12 0.12">
              <a-sphere class="pupil" color="#000" position="0 0 -1" scale="0.2 0.2 0.2"></a-sphere>
            </a-sphere>
          </a-entity>
          <a-entity class="gun">
            <a-box position="0.51 -0.13 -0.29" scale="0.19 0.23 0.67" color="#000"></a-box>
            <a-entity class="gun-tip" position="0.51 -0.10 -0.64"></a-entity>
          </a-entity>
        </a-entity>
      </template>

      <!-- /Templates -->
    </a-assets>

    <a-entity id="rig">
      <a-entity id="player" networked="template:#avatar-template;attachTemplateToLocal:true" camera position="0 4 0"
        wasd-controls look-controls get-stats="enable: true" get-device-info>
        <a-sphere class="head" visible="false" random-color></a-sphere>
      </a-entity>
    </a-entity>
    <a-entity vive-controls="hand: left"></a-entity>
    <a-entity vive-controls="hand: right"></a-entity>



    <a-entity environment="preset:arches"></a-entity>
    <a-entity light="type:ambient;intensity:0.5"></a-entity>

    <div class="statsPanel">
      <table>
        <tr>
          <th>属性</th>
          <th class="value">属性值</th>
        </tr>
        <tr>
          <!-- Vector3 -->
          <td>position</td>
          <td id="position" class="value">position</td>
        </tr>
        <tr>
          <!-- Euler -->
          <td>rotation</td>
          <td id="rotation" class="value">rotation</td>
        </tr>
        <tr>
          <!-- Vector3 -->
          <td>scale</td>
          <td id="scale" class="value">scale</td>
        </tr>
        <tr>
          <!-- Quaternion -->
          <td>quaternion</td>
          <td id="quaternion" class="value">quaternion</td>
        </tr>
        <tr>
          <!-- perspectiveCamera -->
          <td>camera</td>
          <td id="camera" class="value">camera</td>
        </tr>
        <tr>
          <td>worldQuaternion</td>
          <td id="worldQuaternion" class="value">worldQuaternion</td>
        </tr>
        <tr>
          <td>worldPosition</td>
          <td id="worldPosition" class="value">worldPosition</td>
        </tr>
        <tr>
          <td>worldDirection</td>
          <td id="worldDirection" class="value">worldDirection</td>
        </tr>
        <tr>
          <td>cameraWorldDirection</td>
          <td id="cameraWorldDirection" class="value">cameraWorldDirection</td>
        </tr>
        <tr>
          <td>isVrMode</td>
          <td id="isVrMode" class="value">isVrMode</td>
        </tr>
        <tr>
          <td>VRorientation</td>
          <td id="VRorientation" class="value">VRorientation</td>
        </tr>
        <tr>
          <td>VRposition</td>
          <td id="VRposition" class="value">VRposition</td>
        </tr>
      </table>

      <div class="btn">
        <div class="stopBtn"
          onclick="document.body.dispatchEvent(new CustomEvent('disable-stats')); this.textContent='disabled'; this.disabled=true">
          stop</div>
        <div class="downloadBtn" onclick="downloadStats()">
          download</div>
      </div>

    </div>
  </a-scene>

  <script>
    // Called by Networked-Aframe when connected to server
    function onConnect() {
      console.log('onConnect', new Date());
    }
    NAF.schemas.add({
      template: '#avatar-template',
      components: [
        'position',
        'rotation',
        {
          selector: '.head',
          component: 'material',
          property: 'color'
        }
      ]
    });
    let socket = null;
    (document.querySelector('a-scene')).addEventListener('adapter-ready', ({ detail: adapter }) => {
      // disable/enable simulcast
      adapter.simulcastMode = false

      // set heartbeat interval to xx secs
      // adapter.setHeartbeatTimer(100)
    })



    const totalRecord = []
    function downloadStats() {
      if (totalRecord.length <= 5) { return console.log('数据少') }
      const link = document.createElement('a')
      link.href = URL.createObjectURL(new Blob([JSON.stringify(totalRecord)], { type: 'application/json' }))
      link.download = 'stats.json'
      link.click()
      URL.revokeObjectURL(link.href)
    }


    const propertyList = [
      'position',
      'rotation',
      'quaternion',
      'scale',
      'camera',
      'worldDirection',
      'worldQuaternion',
      'worldPosition',
      "cameraWorldDirection",
      "VRorientation",
      "VRposition",
      "isVrMode"
    ]

    const deviceInfoPropertyList = [
      'position',
      'quaternion',
      /*
        gamepads:{
          axes,
          buttons, // array
          hand, // 'left'/'right',
          id, // ''
          pose:{
            position, // array 3
            orientation // array 4
          }

        }
       */
      'gamepads',
      'gamepadInputSources',
      'sessions',
      'resolution',
      'modes'
    ]


    let valueList = propertyList.map(each => document.getElementById(each))
    // console.log(valueList);
    document.body.onload = () => {
      console.log('onload');
      // document.body.addEventListener('update-stats', ({ detail }) => {
      //   let statsObj = {}
      //   let dataList = propertyList.map((_, index) => {
      //     let key = propertyList[index]
      //     let value = detail[key]
      //     let obj = {}

      //     statsObj[key] = value

      //     obj[key] = JSON.stringify(value)

      //     valueList[index].textContent = obj[key]
      //     return obj
      //   }
      //   )

      //   totalRecord.push(statsObj)
      //   // console.log({
      //   //   stats: dataList
      //   // });
      // })

      // document.body.addEventListener('get-device-info', ({ detail: deviceInfo }) => {
      // console.log(deviceInfo);
      //   const { isHMDConnected, device } = deviceInfo
      //   console.log(device);
      //   if (!isHMDConnected) return
      //   const keys = Reflect.ownKeys(device)
      //   const filteredKeys = deviceInfoPropertyList.filter(each => keys.includes(each))
      //   const filteredDeviceInfo = filteredKeys.map(each => {
      //     let value = null;
      //     switch (each) {
      //       case 'position':
      //         // Float32Array length3
      //         [x, y, z] = device.position
      //         value = { x, y, z }
      //         break;
      //       case 'quaternion':
      //         // Float32Array length4
      //         [x, y, z, w] = device.quaternion
      //         value = { x, y, z, w }
      //         break;
      //       case 'sessions':
      //         let sessions = [...device.sessions.values()]
      //         value = sessions
      //         break;
      //       default:
      //         break
      //     }
      //     return {
      //       property: each,
      //       value: value || device[each]
      //     }
      //   })
      //   // console.log(filteredDeviceInfo);
      // })
    }



  </script>

  <!-- VR设备/会话 -->
  <script>
    (async () => {
      const isWebXRSupported = !!navigator.xr
      const isVrSessionSupported = await navigator.xr.isSessionSupported('immersive-vr')
      const isArSessionSupported = await navigator.xr.isSessionSupported('immersive-ar')
      console.log({ isWebXRSupported, isVrSessionSupported, isArSessionSupported });

    })()
  </script>


  <script>
    
  </script>
</body>

</html>